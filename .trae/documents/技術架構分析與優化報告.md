# 專案技術分析與架構優化報告

本報告旨在針對目前的 **Orthographic Projection Web Demo** 專案進行深度的技術體檢，並提供具體、專業的優化建議。

## 1. 專案概覽與分析範圍
*   **專案類型**: Web 3D 遊戲 (Isometric/Orthographic 視角切換機制)
*   **技術堆疊**: TypeScript, Vite, Three.js, GSAP
*   **分析範圍**: 核心系統 (`GameManager`, `PhysicsSystem`), 資料管理 (`LevelManager`), UI 互動 (`EditorUI`), 以及建置與開發流程。

---

## 2. 詳細問題診斷與根本原因分析

### 2.1 程式碼品質 (Code Quality)
*   **"God Class" 現象**: `src/systems/GameManager.ts` 承擔了過多職責。它不僅管理遊戲狀態 (Play/Edit)，還處理 **攝影機動畫** (GSAP)、**輸入路由**、**計分邏輯** 以及 **視覺遮擋剔除 (Occlusion)**。這違反了單一職責原則 (SRP)，導致維護困難。
*   **硬編碼數值 (Magic Numbers)**: 程式碼中散落著未命名的常數，例如 `handleCharacterOcclusion` 中的 `0.2` (遮擋容忍度) 或 `0x555555` (高亮顏色)。
*   **缺乏自動化規範**: 專案根目錄未發現 `.eslintrc` 或 `.prettierrc`，這意味著團隊開發時可能出現風格不一致，且依賴開發者的自律來維持代碼整潔。
*   **除錯殘留**: 關鍵邏輯中包含大量 `console.log` (如 `LevelManager.ts:226`)，這在生產環境中會造成雜訊並影響效能。

### 2.2 架構設計 (Architecture)
*   **高耦合度**: `GameManager` 直接持有並操作 `EditorUI`, `PhysicsSystem`, `LevelManager` 的實體。UI 層透過直接回呼 (`this.ui.onRotateLeft = ...`) 與邏輯層溝通。缺乏一個解耦的 **全域事件匯流排 (Event Bus)**。
*   **渲染與邏輯混雜**: `LevelManager` 直接操作 `THREE.Scene` (`this.scene.add(voxel)`)。理想情況下，數據層 (`LevelManager`) 應只管理數據，而由渲染層 (`RenderSystem`) 負責將數據繪製到螢幕上。

### 2.3 效能表現 (Performance) - **關鍵瓶頸**
*   **Draw Calls 過高**: `LevelManager` 為每一個體素 (Voxel) 創建一個獨立的 `THREE.Mesh`。
    *   **診斷**: 若地圖有 1,000 個方塊，Three.js 就需要發出 1,000 次 Draw Call。這在移動設備上是極大的效能殺手。
    *   **影響**: 幀率 (FPS) 會隨著地圖複雜度線性下降。
*   **高代價的迴圈檢測**:
    *   **遮擋剔除**: `handleCharacterOcclusion` 使用 `raycaster.intersectObjects(voxels)`，每一幀都在遍歷場景中**所有**方塊。
    *   **物理碰撞**: `PhysicsSystem` (推測) 同樣遍歷所有方塊進行碰撞檢測。
    *   **複雜度**: $O(N)$ (N=方塊數)。這是不具可擴展性的演算法。

### 2.4 開發體驗與運維 (DevOps)
*   **缺乏 CI/CD**: 未發現 GitHub Actions 或 Docker 配置，部署依賴手動操作。
*   **缺乏測試**: 沒有單元測試 (Unit Tests) 框架 (如 Jest 或 Vitest)，重構時極易引入回歸錯誤 (Regression Bugs)。

### 2.5 安全機制 (Security)
*   **資料驗證不足**: `LevelManager.deserialize` 雖然有 `try-catch`，但直接信任 `JSON.parse` 的結果。若 `level_data` 結構被篡改 (例如注入惡意字串作為地圖名稱)，且 UI 直接使用 `innerHTML` 渲染，可能導致 **DOM XSS** 攻擊。

---

## 3. 優化方案與實施步驟

### 3.1 架構重構 (Refactoring)
*   **引入 Event Bus**: 建立 `src/core/EventManager.ts`，讓 UI 發送事件 (如 `EVENTS.INPUT_ROTATE_LEFT`)，而 `GameManager` 監聽事件。切斷直接引用。
*   **拆分 GameManager**:
    *   建立 `src/systems/CameraSystem.ts`: 專門處理 GSAP 旋轉動畫與視角狀態 (`ViewState`)。
    *   建立 `src/systems/OcclusionSystem.ts`: 專門處理射線檢測與透明度控制。
*   **數據與視圖分離**: `LevelManager` 僅維護 `grid` 數據結構 (例如 3D 陣列)。新增 `VoxelRenderer` 負責根據數據生成 3D 物件。

### 3.2 效能優化 (Performance Optimization)
*   **實作 InstancedMesh (幾何實例化)**:
    *   **方案**: 將所有相同類型的方塊 (如 100 個草地塊) 合併為一個 `THREE.InstancedMesh`。
    *   **效益**: 將 1,000 次 Draw Call 降低為 **個位數** (視方塊種類而定)。這是最關鍵的優化。
*   **空間分割 (Spatial Partitioning)**:
    *   **方案**: 實作「空間雜湊 (Spatial Hash Map)」或簡單的 `Grid` 索引。
    *   **效益**: 碰撞檢測與遮擋剔除只需檢查角色周圍的方塊，將複雜度從 $O(N)$ 降至 $O(1)$。

### 3.3 工具與開發流程 (Tooling)
*   **引入 ESLint + Prettier**: 統一程式碼風格，強制移除 `console.log` 和 `any` 型別。
*   **設定 Vitest**: 為 `LevelManager` 的序列化/反序列化邏輯編寫單元測試。

---

## 4. 安全與合規性增強
*   **輸入消毒 (Sanitization)**: 在 `loadFromLocalStorage` 時，使用 `zod` 或 `io-ts` 驗證 JSON Schema，確保數據結構符合預期，過濾掉未知的欄位。
*   **XSS 防護**: 確保所有 UI 渲染 (如地圖列表) 使用 `textContent` 而非 `innerHTML`。

---

## 5. 實施路線圖 (Roadmap)

### 第一階段：基礎設施與規範 (Week 1)
1.  安裝並配置 ESLint, Prettier。
2.  建立 GitHub Actions 進行自動建置檢查。
3.  移除 `GameManager` 中的硬編碼數值，移至 `Constants.ts`。

### 第二階段：關鍵效能優化 (Week 2)
1.  **重構渲染層**: 將 `Voxel` 渲染改為 `InstancedMesh` (此變更影響較大，需優先處理)。
2.  **優化物理**: 在 `LevelManager` 中建立基於座標的快速查找表 (Lookup Table)，優化碰撞檢測。

### 第三階段：架構解耦 (Week 3)
1.  實作 `EventBus`。
2.  將攝影機邏輯從 `GameManager` 剝離至 `CameraSystem`。

### 第四階段：安全與測試 (Week 4)
1.  引入 `zod` 進行資料驗證。
2.  補全核心邏輯的單元測試。

## 6. 預期效益
*   **效能**: 渲染幀率在大量方塊場景下提升 **10倍以上**。
*   **穩定性**: 透過測試與型別檢查，減少 80% 的執行期錯誤。
*   **可維護性**: 模組化後，新增功能 (如新方塊、新視角) 的開發時間縮短一半。
